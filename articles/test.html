<h2 id="concurrent-database-access">Concurrent Database Access</h2>

<p>I wrote small article which describe how to make access to your android database thread safe.</p>

<hr>

<p>Assuming you have your own <a href="http://developer.android.com/reference/android/database/sqlite/SQLiteOpenHelper.html">SQLiteOpenHelper</a>.</p>

<pre><code>public class DatabaseHelper extends SQLiteOpenHelper { ... }
</code></pre>

<p>Now you want to write data to database in separate threads.</p>

<pre class="prettyprint prettyprinted" style=""><code class="language-java"><span class="pln"> </span><span class="com">// Thread 1</span><span class="pln">
 </span><span class="typ">Context</span><span class="pln"> context </span><span class="pun">=</span><span class="pln"> getApplicationContext</span><span class="pun">();</span><span class="pln">
 </span><span class="typ">DatabaseHelper</span><span class="pln"> helper </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DatabaseHelper</span><span class="pun">(</span><span class="pln">context</span><span class="pun">);</span><span class="pln">
 </span><span class="typ">SQLiteDatabase</span><span class="pln"> database </span><span class="pun">=</span><span class="pln"> helper</span><span class="pun">.</span><span class="pln">getWritableDatabase</span><span class="pun">();</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">insert</span><span class="pun">(…);</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><span class="pln">

 </span><span class="com">// Thread 2</span><span class="pln">
 </span><span class="typ">Context</span><span class="pln"> context </span><span class="pun">=</span><span class="pln"> getApplicationContext</span><span class="pun">();</span><span class="pln">
 </span><span class="typ">DatabaseHelper</span><span class="pln"> helper </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DatabaseHelper</span><span class="pun">(</span><span class="pln">context</span><span class="pun">);</span><span class="pln">
 </span><span class="typ">SQLiteDatabase</span><span class="pln"> database </span><span class="pun">=</span><span class="pln"> helper</span><span class="pun">.</span><span class="pln">getWritableDatabase</span><span class="pun">();</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">insert</span><span class="pun">(…);</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span></code></pre>

<p>You will get following message in your logcat and one of your changes will not be written.</p>

<pre class="prettyprint prettyprinted" style=""><code class="language-java"><span class="pln">android</span><span class="pun">.</span><span class="pln">database</span><span class="pun">.</span><span class="pln">sqlite</span><span class="pun">.</span><span class="typ">SQLiteDatabaseLockedException</span><span class="pun">:</span><span class="pln"> database is locked </span><span class="pun">(</span><span class="pln">code </span><span class="lit">5</span><span class="pun">)</span></code></pre>

<p>This is happening because every time you create new <code>SQLiteOpenHelper</code> object you are actually making new database connection. If you try to write to the database from actual distinct connections at the same time, one will fail.</p>

<h3 id="to-use-database-with-multiple-threads-we-need-to-make-sure-we-are-using-one-database-connection">To use database with multiple threads we need to make sure we are using one database connection.</h3>

<p>Let’s make singleton class <code>DatabaseManager</code> which will hold and return single <code>SQLiteOpenHelper</code> object.</p>

<pre class="prettyprint prettyprinted" style=""><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pln"> instance</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">SQLiteOpenHelper</span><span class="pln"> mDatabaseHelper</span><span class="pun">;</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">synchronized</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> initialize</span><span class="pun">(</span><span class="typ">Context</span><span class="pln"> context</span><span class="pun">,</span><span class="pln"> </span><span class="typ">SQLiteOpenHelper</span><span class="pln"> helper</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instance </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
            instance </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pun">();</span><span class="pln">
            mDatabaseHelper </span><span class="pun">=</span><span class="pln"> helper</span><span class="pun">;</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">synchronized</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pln"> getInstance</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instance </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
            </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">IllegalStateException</span><span class="pun">(</span><span class="typ">DatabaseManager</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">getSimpleName</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
                    </span><span class="str">" is not initialized, call initialize(..) method first."</span><span class="pun">);</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">

        </span><span class="kwd">return</span><span class="pln"> instance</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">SQLiteDatabase</span><span class="pln"> getDatabase</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> mDatabaseHelper</span><span class="pun">.</span><span class="pln">getWritableDatabase</span><span class="pun">();</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>

<p>Updated code which write data to database in separate threads will look like this.</p>

<pre class="prettyprint prettyprinted" style=""><code class="language-java"><span class="pln"> </span><span class="com">// In your application class</span><span class="pln">
 </span><span class="typ">DatabaseManager</span><span class="pun">.</span><span class="pln">initializeInstance</span><span class="pun">(</span><span class="pln">getApplicationContext</span><span class="pun">());</span><span class="pln">

 </span><span class="com">// Thread 1</span><span class="pln">
 </span><span class="typ">DatabaseManager</span><span class="pln"> manager </span><span class="pun">=</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pun">.</span><span class="pln">getInstance</span><span class="pun">();</span><span class="pln">
 </span><span class="typ">SQLiteDatabase</span><span class="pln"> database </span><span class="pun">=</span><span class="pln"> manager</span><span class="pun">.</span><span class="pln">getDatabase</span><span class="pun">()</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">insert</span><span class="pun">(…);</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><span class="pln">

 </span><span class="com">// Thread 2</span><span class="pln">
 </span><span class="typ">DatabaseManager</span><span class="pln"> manager </span><span class="pun">=</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pun">.</span><span class="pln">getInstance</span><span class="pun">();</span><span class="pln">
 </span><span class="typ">SQLiteDatabase</span><span class="pln"> database </span><span class="pun">=</span><span class="pln"> manager</span><span class="pun">.</span><span class="pln">getDatabase</span><span class="pun">()</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">insert</span><span class="pun">(…);</span><span class="pln">
 database</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span></code></pre>

<p>This will bring you another crash.</p>

<pre class="prettyprint prettyprinted" style=""><code class="language-java"><span class="pln">java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="typ">IllegalStateException</span><span class="pun">:</span><span class="pln"> attempt to re</span><span class="pun">-</span><span class="pln">open an already</span><span class="pun">-</span><span class="pln">closed object</span><span class="pun">:</span><span class="pln"> </span><span class="typ">SQLiteDatabase</span></code></pre>

<p>Since we are using only one database connection, method <code>getDatabase()</code> return same instance of <code>SQLiteDatabase</code> object for <code>Thread1</code> and <code>Thread2</code>. What is happening, <code>Thread1</code> may close database, while <code>Thread2</code> is still using it. That’s why we have <code>IllegalStateException</code> crash.</p>

<p>We need to make sure no-one is using database and only then close it. Some folks on <a href="http://stackoverflow.com/">stackoveflow</a> recommended to never close your <code>SQLiteDatabase</code>. It not only sounds stupid but also honor you with following logcat message.</p>

<pre class="prettyprint prettyprinted" style=""><code class="language-java"><span class="typ">Leak</span><span class="pln"> found
</span><span class="typ">Caused</span><span class="pln"> by</span><span class="pun">:</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="typ">IllegalStateException</span><span class="pun">:</span><span class="pln"> </span><span class="typ">SQLiteDatabase</span><span class="pln"> created and never closed</span></code></pre>

<h2 id="working-sample">Working sample</h2>

<pre class="prettyprint prettyprinted" style=""><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">AtomicInteger</span><span class="pln"> mOpenCounter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">AtomicInteger</span><span class="pun">();</span><span class="pln">

    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pln"> instance</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">SQLiteOpenHelper</span><span class="pln"> mDatabaseHelper</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">SQLiteDatabase</span><span class="pln"> mDatabase</span><span class="pun">;</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">synchronized</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> initializeInstance</span><span class="pun">(</span><span class="typ">SQLiteOpenHelper</span><span class="pln"> helper</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instance </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
            instance </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pun">();</span><span class="pln">
            mDatabaseHelper </span><span class="pun">=</span><span class="pln"> helper</span><span class="pun">;</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">synchronized</span><span class="pln"> </span><span class="typ">DatabaseManager</span><span class="pln"> getInstance</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instance </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
            </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">IllegalStateException</span><span class="pun">(</span><span class="typ">DatabaseManager</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">getSimpleName</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
                    </span><span class="str">" is not initialized, call initializeInstance(..) method first."</span><span class="pun">);</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">

        </span><span class="kwd">return</span><span class="pln"> instance</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">SQLiteDatabase</span><span class="pln"> openDatabase</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">mOpenCounter</span><span class="pun">.</span><span class="pln">incrementAndGet</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
            </span><span class="com">// Opening new database</span><span class="pln">
            mDatabase </span><span class="pun">=</span><span class="pln"> mDatabaseHelper</span><span class="pun">.</span><span class="pln">getWritableDatabase</span><span class="pun">();</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
        </span><span class="kwd">return</span><span class="pln"> mDatabase</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> closeDatabase</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">mOpenCounter</span><span class="pun">.</span><span class="pln">decrementAndGet</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
            </span><span class="com">// Closing database</span><span class="pln">
            mDatabase</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><span class="pln">

        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="pun">}</span></code></pre>

<p>And use it as follows.</p>

<pre><code>SQLiteDatabase database = DatabaseManager.getInstance().openDatabase();
database.insert(...);
// database.close(); Don't close it directly!
DatabaseManager.getInstance().closeDatabase(); // correct way
</code></pre>

<p>Every time you need database you should call <em>openDatabase()</em> method of <em>DatabaseManager</em> class. Inside this method, we have a counter, which indicate how many times database is opened. If it equals to one, it means we need to create new database, if not, database is already created. </p>

<p>The same happens in <em>closeDatabase()</em> method. Every time we call this method, counter is decreased, whenever it goes to zero, we are closing database.</p>

<p><strong>Note:</strong> You should use <a href="http://developer.android.com/reference/java/util/concurrent/atomic/AtomicInteger.html">AtomicInteger</a> to deal with concurrency.</p>

<hr>

<p>Now you should be able to use your database and be sure - it’s thread safe.</p>